create schema if not exists workflows_manager;
create extension if not exists "uuid-ossp";

create domain workflows_manager.email as varchar(255);

create domain workflows_manager.username as varchar(255);

-- product_info
create table if not exists workflows_manager.product_info
(
    id         integer generated by default as identity
        constraint pk_product_info primary key,
    key        varchar(255)                           not null,
    value      text                                   not null,
    created_at timestamp with time zone default now() not null,
    constraint uq_product_info_key unique (key)
);

-- license
create table if not exists workflows_manager.license
(
    id           uuid                                   not null
        constraint pk_license primary key,
    license_text text                                   not null,
    issued_at    timestamp with time zone               not null,
    expires_at   timestamp with time zone               not null,
    client_id    uuid                                   not null,
    type         varchar(50)                            not null,
    created_at   timestamp with time zone default now() not null,
    constraint ck_license_dates_range check (issued_at <= expires_at)
);

-- license_history
create table if not exists workflows_manager.license_history
(
    id           uuid                                   not null
        constraint pk_license_history primary key,
    license_id   uuid                                   not null,
    license_text text                                   not null,
    issued_at    timestamp with time zone               not null,
    expires_at   timestamp with time zone               not null,
    client_id    uuid                                   not null,
    type         varchar(50)                            not null,
    created_at   timestamp with time zone default now() not null,
    constraint ck_license_history_dates_range check (issued_at <= expires_at),
    constraint fk_license_history_license
        foreign key (license_id) references workflows_manager.license (id) on delete cascade
);

create index if not exists idx_license_history_license_id on workflows_manager.license_history (license_id);

-- tenants
create table if not exists workflows_manager.tenants
(
    id         integer generated by default as identity
        constraint pk_tenants primary key,
    name       varchar(255)                           not null,
    created_at timestamp with time zone default now() not null,
    constraint uq_tenants_name unique (name)
);

-- projects
create table if not exists workflows_manager.projects
(
    id          integer generated by default as identity
        constraint pk_projects primary key,
    name        varchar(128)                           not null,
    description varchar(300),
    tenant_id   integer                                not null,
    archived    boolean                  default false not null,
    created_at  timestamp with time zone default now() not null,
    updated_at  timestamp with time zone default now() not null,
    archived_at timestamp with time zone,
    constraint uq_projects_name unique (name),
    constraint fk_projects_tenant
        foreign key (tenant_id) references workflows_manager.tenants (id) on delete restrict
);

create index if not exists idx_projects_tenant_id on workflows_manager.projects (tenant_id);

-- users
create table if not exists workflows_manager.users
(
    id                  integer generated by default as identity
        constraint pk_users primary key,
    username            workflows_manager.username                     not null,
    email               workflows_manager.email                        not null,
    password_hash       varchar(255)                           not null,
    is_superuser        boolean                  default false not null,
    is_active           boolean                  default true  not null,
    created_at          timestamp with time zone default now() not null,
    updated_at          timestamp with time zone default now() not null,
    last_login          timestamp with time zone default CURRENT_TIMESTAMP,
    is_tmp_password     boolean                  default true,
    two_fa_enabled      boolean                  default false not null,
    two_fa_secret       text,
    two_fa_confirmed_at timestamp with time zone,
    is_external         boolean                  default false not null,
    license_accepted    boolean                  default false not null,
    constraint uq_users_username unique (username),
    constraint uq_users_email unique (email)
);

-- roles
create table if not exists workflows_manager.roles
(
    id          uuid                     default gen_random_uuid() not null
        constraint pk_roles primary key,
    key         varchar(50)                                        not null,
    name        varchar(50)                                        not null,
    description varchar(300),
    created_at  timestamp with time zone default now()             not null,
    constraint uq_roles_key unique (key)
);

-- permissions
create table if not exists workflows_manager.permissions
(
    id   uuid default gen_random_uuid() not null
        constraint pk_permissions primary key,
    key  varchar(50)                    not null,
    name varchar(50)                    not null,
    constraint uq_permissions_key unique (key)
);

-- role_permissions (многие-ко-многим)
create table if not exists workflows_manager.role_permissions
(
    role_id       uuid not null,
    permission_id uuid not null,
    constraint pk_role_permissions primary key (role_id, permission_id),
    constraint fk_role_permissions_role
        foreign key (role_id) references workflows_manager.roles (id) on delete cascade,
    constraint fk_role_permissions_permission
        foreign key (permission_id) references workflows_manager.permissions (id) on delete cascade
);

create index if not exists idx_role_permissions_role_id on workflows_manager.role_permissions (role_id);
create index if not exists idx_role_permissions_permission_id on workflows_manager.role_permissions (permission_id);

-- memberships
create table if not exists workflows_manager.memberships
(
    id         integer generated by default as identity
        constraint pk_memberships primary key,
    project_id integer                                not null,
    user_id    integer                                not null,
    role_id    uuid                                   not null,
    created_at timestamp with time zone default now() not null,
    updated_at timestamp with time zone default now() not null,
    constraint uq_membership_project_user unique (project_id, user_id),
    constraint fk_memberships_project
        foreign key (project_id) references workflows_manager.projects (id) on delete cascade,
    constraint fk_memberships_user
        foreign key (user_id) references workflows_manager.users (id) on delete cascade,
    constraint fk_memberships_role
        foreign key (role_id) references workflows_manager.roles (id) on delete restrict
);

create index if not exists idx_memberships_project_id on workflows_manager.memberships (project_id);
create index if not exists idx_memberships_user_id on workflows_manager.memberships (user_id);
create index if not exists idx_memberships_role_id on workflows_manager.memberships (role_id);

create or replace function workflows_manager.normalize_key() returns trigger
    language plpgsql as
$$
begin
    if NEW.key is not null then
        NEW.key := lower(NEW.key);
    end if;
    return NEW;
end;
$$;

drop trigger if exists trg_roles_normalize_key on workflows_manager.roles;
create trigger trg_roles_normalize_key
    before insert or update
    on workflows_manager.roles
    for each row
execute function workflows_manager.normalize_key();

drop trigger if exists trg_permissions_normalize_key on workflows_manager.permissions;
create trigger trg_permissions_normalize_key
    before insert or update
    on workflows_manager.permissions
    for each row
execute function workflows_manager.normalize_key();

drop trigger if exists trg_product_info_normalize_key on workflows_manager.product_info;
create trigger trg_product_info_normalize_key
    before insert or update
    on workflows_manager.product_info
    for each row
execute function workflows_manager.normalize_key();

insert into workflows_manager.roles (id, key, name, description)
values ('c80633be-e36b-4fb8-8d5d-f4b05c449d37', 'project_owner', 'Project Owner', 'Full control of project'),
       ('348a558f-b00a-419b-a8a4-699f6f8eae3f', 'project_manager', 'Project Manager', 'Manage workflows'),
       ('fb1c0bf4-65bf-4141-8723-170dffb797fa', 'project_viewer', 'Project Viewer', 'Read-only')
on conflict (key) do nothing;

insert into workflows_manager.permissions (id, key, name)
values ('b0ca1ed0-07aa-4fa2-a843-8253799240ae', 'project.view', 'View project'),
       ('4465a5a3-ea1e-4ed8-a905-217368483ac4', 'project.manage', 'Manage project'),
       ('a6f3cc48-0698-4f12-8e89-7a9e02fd30b2', 'audit.view', 'View audit'),
       ('bb1bc5da-fbe2-4b7d-8088-9ff7642034ce', 'membership.manage', 'Manage memberships'),
       ('c100b088-0163-4ae1-82d6-f2eeace0621a', 'project.create', 'Create projects')
on conflict (key) do nothing;

insert into workflows_manager.role_permissions (role_id, permission_id)
values ('c80633be-e36b-4fb8-8d5d-f4b05c449d37', 'b0ca1ed0-07aa-4fa2-a843-8253799240ae'),
       ('348a558f-b00a-419b-a8a4-699f6f8eae3f', 'b0ca1ed0-07aa-4fa2-a843-8253799240ae'),
       ('fb1c0bf4-65bf-4141-8723-170dffb797fa', 'b0ca1ed0-07aa-4fa2-a843-8253799240ae'),
       ('c80633be-e36b-4fb8-8d5d-f4b05c449d37', '4465a5a3-ea1e-4ed8-a905-217368483ac4'),
       ('348a558f-b00a-419b-a8a4-699f6f8eae3f', '4465a5a3-ea1e-4ed8-a905-217368483ac4'),
       ('c80633be-e36b-4fb8-8d5d-f4b05c449d37', 'a6f3cc48-0698-4f12-8e89-7a9e02fd30b2'),
       ('348a558f-b00a-419b-a8a4-699f6f8eae3f', 'a6f3cc48-0698-4f12-8e89-7a9e02fd30b2'),
       ('c80633be-e36b-4fb8-8d5d-f4b05c449d37', 'bb1bc5da-fbe2-4b7d-8088-9ff7642034ce')
on conflict (role_id, permission_id) do nothing;

insert into workflows_manager.tenants (name, created_at) values ('Tenant 1', now()) on conflict (name) do nothing;

create table if not exists workflows_manager.membership_audit
(
    id            bigserial
        primary key,
    membership_id integer,
    actor_user_id integer,
    action        varchar(50)                            not null,
    old_value     jsonb,
    new_value     jsonb,
    created_at    timestamp with time zone default now() not null
);

create table if not exists workflows_manager.ldap_sync_stats
(
    id              serial
        primary key,
    sync_session_id uuid                                                          not null
        unique,
    start_time      timestamp with time zone default now()                        not null,
    end_time        timestamp with time zone,
    duration        varchar(50),
    total_users     integer                  default 0                            not null,
    synced_users    integer                  default 0                            not null,
    errors          integer                  default 0                            not null,
    warnings        integer                  default 0                            not null,
    status          varchar(20)              default 'running'::character varying not null,
    error_message   text
);

create index if not exists idx_ldap_sync_stats_sync_session_id
    on workflows_manager.ldap_sync_stats (sync_session_id);

create index if not exists idx_ldap_sync_stats_start_time
    on workflows_manager.ldap_sync_stats (start_time);

create index if not exists idx_ldap_sync_stats_status
    on workflows_manager.ldap_sync_stats (status);

create table if not exists workflows_manager.ldap_sync_logs
(
    id                 serial
        primary key,
    timestamp          timestamp with time zone default now() not null,
    level              varchar(10)                            not null,
    message            text                                   not null,
    username           varchar(255),
    details            text,
    sync_session_id    uuid                                   not null,
    stack_trace        text,
    ldap_error_code    integer,
    ldap_error_message text
);

create table if not exists workflows_manager.settings
(
    id          serial primary key,
    name        varchar(50) not null unique,
    value       jsonb        not null,
    description varchar(300),
    created_at  timestamp with time zone default now(),
    updated_at  timestamp with time zone default now()
);

create index if not exists idx_ldap_sync_logs_timestamp
    on workflows_manager.ldap_sync_logs (timestamp);

create index if not exists idx_ldap_sync_logs_level
    on workflows_manager.ldap_sync_logs (level);

create index if not exists idx_ldap_sync_logs_sync_session_id
    on workflows_manager.ldap_sync_logs (sync_session_id);

create index if not exists idx_ldap_sync_logs_username
    on workflows_manager.ldap_sync_logs (username);

create or replace view workflows_manager.v_user_project_permissions(user_id, project_id, role_key, permissions) as
SELECT m.user_id,
       m.project_id,
       r.key                                                                    AS role_key,
       json_agg(json_build_object('key', p.key, 'name', p.name) ORDER BY p.key) AS permissions
FROM workflows_manager.memberships m
         JOIN workflows_manager.roles r ON r.id = m.role_id
         LEFT JOIN workflows_manager.role_permissions rp ON rp.role_id = r.id
         LEFT JOIN workflows_manager.permissions p ON p.id = rp.permission_id
GROUP BY m.user_id, m.project_id, r.key
ORDER BY m.user_id, m.project_id;

create or replace view workflows_manager.v_role_permissions(role_id, role_key, role_name, permissions) as
SELECT r.id                                                                     AS role_id,
       r.key                                                                    AS role_key,
       r.name                                                                   AS role_name,
       json_agg(json_build_object('key', p.key, 'name', p.name) ORDER BY p.key) AS permissions
FROM workflows_manager.roles r
         LEFT JOIN workflows_manager.role_permissions rp ON rp.role_id = r.id
         LEFT JOIN workflows_manager.permissions p ON p.id = rp.permission_id
GROUP BY r.id, r.key, r.name
ORDER BY r.key;
