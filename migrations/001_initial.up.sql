create domain workflows.email as varchar(255)
    check (value ~* '^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$');

create domain workflows.username as varchar(255)
    check (value ~* '^[a-zA-Z0-9._-]{3,255}$');

-- product_info
create table if not exists workflows.product_info
(
    id         integer generated by default as identity
        constraint pk_product_info primary key,
    key        varchar(255)                           not null,
    value      text                                   not null,
    created_at timestamp with time zone default now() not null,
    constraint uq_product_info_key unique (key)
);

-- license
create table if not exists workflows.license
(
    id           uuid                                   not null
        constraint pk_license primary key,
    license_text text                                   not null,
    issued_at    timestamp with time zone               not null,
    expires_at   timestamp with time zone               not null,
    client_id    uuid                                   not null,
    type         varchar(50)                            not null,
    created_at   timestamp with time zone default now() not null,
    constraint ck_license_dates_range check (issued_at <= expires_at)
);

-- license_history
create table if not exists workflows.license_history
(
    id           uuid                                   not null
        constraint pk_license_history primary key,
    license_id   uuid                                   not null,
    license_text text                                   not null,
    issued_at    timestamp with time zone               not null,
    expires_at   timestamp with time zone               not null,
    client_id    uuid                                   not null,
    type         varchar(50)                            not null,
    created_at   timestamp with time zone default now() not null,
    constraint ck_license_history_dates_range check (issued_at <= expires_at),
    constraint fk_license_history_license
        foreign key (license_id) references workflows.license (id) on delete cascade
);

create index if not exists idx_license_history_license_id on workflows.license_history (license_id);

-- tenants
create table if not exists workflows.tenants
(
    id         integer generated by default as identity
        constraint pk_tenants primary key,
    name       varchar(255)                           not null,
    created_at timestamp with time zone default now() not null,
    constraint uq_tenants_name unique (name)
);

-- projects
create table if not exists workflows.projects
(
    id          integer generated by default as identity
        constraint pk_projects primary key,
    name        varchar(128)                           not null,
    description varchar(300),
    tenant_id   integer                                not null,
    archived    boolean                  default false not null,
    created_at  timestamp with time zone default now() not null,
    updated_at  timestamp with time zone default now() not null,
    archived_at timestamp with time zone,
    constraint uq_projects_name unique (name),
    constraint fk_projects_tenant
        foreign key (tenant_id) references workflows.tenants (id) on delete restrict
);

create index if not exists idx_projects_tenant_id on workflows.projects (tenant_id);

-- users
create table if not exists workflows.users
(
    id                  integer generated by default as identity
        constraint pk_users primary key,
    username            workflows.username                     not null,
    email               workflows.email                        not null,
    password_hash       varchar(255)                           not null,
    is_superuser        boolean                  default false not null,
    is_active           boolean                  default true  not null,
    created_at          timestamp with time zone default now() not null,
    updated_at          timestamp with time zone default now() not null,
    last_login          timestamp with time zone default CURRENT_TIMESTAMP,
    is_tmp_password     boolean                  default true,
    two_fa_enabled      boolean                  default false not null,
    two_fa_secret       text,
    two_fa_confirmed_at timestamp with time zone,
    is_external         boolean                  default false not null,
    license_accepted    boolean                  default false not null,
    constraint uq_users_username unique (username),
    constraint uq_users_email unique (email)
);

-- roles
create table if not exists workflows.roles
(
    id          uuid                     default gen_random_uuid() not null
        constraint pk_roles primary key,
    key         varchar(50)                                        not null,
    name        varchar(50)                                        not null,
    description varchar(300),
    created_at  timestamp with time zone default now()             not null,
    constraint uq_roles_key unique (key)
);

-- permissions
create table if not exists workflows.permissions
(
    id   uuid default gen_random_uuid() not null
        constraint pk_permissions primary key,
    key  varchar(50)                    not null,
    name varchar(50)                    not null,
    constraint uq_permissions_key unique (key)
);

-- role_permissions (многие-ко-многим)
create table if not exists workflows.role_permissions
(
    id            uuid default gen_random_uuid() not null
        constraint pk_role_permissions primary key,
    role_id       uuid                           not null,
    permission_id uuid                           not null,
    constraint uq_role_permissions unique (role_id, permission_id),
    constraint fk_role_permissions_role
        foreign key (role_id) references workflows.roles (id) on delete cascade,
    constraint fk_role_permissions_permission
        foreign key (permission_id) references workflows.permissions (id) on delete cascade
);

create index if not exists idx_role_permissions_role_id on workflows.role_permissions (role_id);
create index if not exists idx_role_permissions_permission_id on workflows.role_permissions (permission_id);

-- memberships
create table if not exists workflows.memberships
(
    id         integer generated by default as identity
        constraint pk_memberships primary key,
    project_id integer                                not null,
    user_id    integer                                not null,
    role_id    uuid                                   not null,
    created_at timestamp with time zone default now() not null,
    updated_at timestamp with time zone default now() not null,
    constraint uq_membership_project_user unique (project_id, user_id),
    constraint fk_memberships_project
        foreign key (project_id) references workflows.projects (id) on delete cascade,
    constraint fk_memberships_user
        foreign key (user_id) references workflows.users (id) on delete cascade,
    constraint fk_memberships_role
        foreign key (role_id) references workflows.roles (id) on delete restrict
);

create index if not exists idx_memberships_project_id on workflows.memberships (project_id);
create index if not exists idx_memberships_user_id on workflows.memberships (user_id);
create index if not exists idx_memberships_role_id on workflows.memberships (role_id);


create or replace function workflows.normalize_key() returns trigger
    language plpgsql as
$$
begin
    if NEW.key is not null then
        NEW.key := lower(NEW.key);
    end if;
    return NEW;
end;
$$;

drop trigger if exists trg_roles_normalize_key on workflows.roles;
create trigger trg_roles_normalize_key
    before insert or update
    on workflows.roles
    for each row
execute function workflows.normalize_key();

drop trigger if exists trg_permissions_normalize_key on workflows.permissions;
create trigger trg_permissions_normalize_key
    before insert or update
    on workflows.permissions
    for each row
execute function workflows.normalize_key();

drop trigger if exists trg_product_info_normalize_key on workflows.product_info;
create trigger trg_product_info_normalize_key
    before insert or update
    on workflows.product_info
    for each row
execute function workflows.normalize_key();

insert into workflows.roles (id, key, name, description)
values ('c80633be-e36b-4fb8-8d5d-f4b05c449d37', 'project_owner', 'Project Owner', 'Full control of project'),
       ('348a558f-b00a-419b-a8a4-699f6f8eae3f', 'project_manager', 'Project Manager', 'Manage workflows'),
       ('fb1c0bf4-65bf-4141-8723-170dffb797fa', 'project_viewer', 'Project Viewer', 'Read-only')
on conflict (key) do nothing;

insert into workflows.permissions (id, key, name)
values ('b0ca1ed0-07aa-4fa2-a843-8253799240ae', 'project.view', 'View project'),
       ('4465a5a3-ea1e-4ed8-a905-217368483ac4', 'project.manage', 'Manage project'),
       ('a6f3cc48-0698-4f12-8e89-7a9e02fd30b2', 'audit.view', 'View audit'),
       ('bb1bc5da-fbe2-4b7d-8088-9ff7642034ce', 'membership.manage', 'Manage memberships'),
       ('c100b088-0163-4ae1-82d6-f2eeace0621a', 'project.create', 'Create projects')
on conflict (key) do nothing;

insert into workflows.role_permissions (id, role_id, permission_id)
values ('c243ca60-1307-4b92-83ea-a1c22791968b', 'c80633be-e36b-4fb8-8d5d-f4b05c449d37',
        'b0ca1ed0-07aa-4fa2-a843-8253799240ae'),
       ('c2a2145e-d598-4e73-bf63-00cd0bfdb015', '348a558f-b00a-419b-a8a4-699f6f8eae3f',
        'b0ca1ed0-07aa-4fa2-a843-8253799240ae'),
       ('a1545c30-9929-4594-9653-1af6072b92af', 'fb1c0bf4-65bf-4141-8723-170dffb797fa',
        'b0ca1ed0-07aa-4fa2-a843-8253799240ae'),
       ('80468ccf-dd5d-4ddd-85b1-34465574b829', 'c80633be-e36b-4fb8-8d5d-f4b05c449d37',
        '4465a5a3-ea1e-4ed8-a905-217368483ac4'),
       ('e3c4b44b-ca8e-44e6-b6d9-e2cf2a3515fc', '348a558f-b00a-419b-a8a4-699f6f8eae3f',
        '4465a5a3-ea1e-4ed8-a905-217368483ac4'),
       ('734e6b92-7aaf-4091-9643-d542b9e09f9e', 'c80633be-e36b-4fb8-8d5d-f4b05c449d37',
        'a6f3cc48-0698-4f12-8e89-7a9e02fd30b2'),
       ('98de5120-230b-45b8-b3dd-3bf61d5471c2', '348a558f-b00a-419b-a8a4-699f6f8eae3f',
        'a6f3cc48-0698-4f12-8e89-7a9e02fd30b2'),
       ('598319f4-4ff9-47bf-9ab5-ea50cb929587', 'c80633be-e36b-4fb8-8d5d-f4b05c449d37',
        'bb1bc5da-fbe2-4b7d-8088-9ff7642034ce')
on conflict (role_id, permission_id) do nothing;

insert into workflows.tenants (name, created_at) values ('default', now()) on conflict (name) do nothing;
